FROM node:20-alpine AS build

WORKDIR /app

ARG REACT_APP_DD_APPLICATION_ID
ARG REACT_APP_DD_CLIENT_TOKEN
ARG REACT_APP_DD_SITE=datadoghq.com
ARG REACT_APP_DD_SERVICE=kelvo-ecomm
ARG REACT_APP_DD_ENV=local
ARG REACT_APP_DD_VERSION=1.0.0
ARG REACT_APP_ORDER_API=http://localhost:8080
ARG REACT_APP_CART_API=http://localhost:3001
ARG REACT_APP_AUTH_API=http://localhost:3002
ARG REACT_APP_PAYMENT_API=http://localhost:3003
ARG REACT_APP_SEARCH_API=http://localhost:3004
ARG REACT_APP_RECOMMENDATIONS_API=http://localhost:3005
ARG REACT_APP_NOTIFICATIONS_API=http://localhost:3006

ENV REACT_APP_DD_APPLICATION_ID=$REACT_APP_DD_APPLICATION_ID \
    REACT_APP_DD_CLIENT_TOKEN=$REACT_APP_DD_CLIENT_TOKEN \
    REACT_APP_DD_SITE=$REACT_APP_DD_SITE \
    REACT_APP_DD_SERVICE=$REACT_APP_DD_SERVICE \
    REACT_APP_DD_ENV=$REACT_APP_DD_ENV \
    REACT_APP_DD_VERSION=$REACT_APP_DD_VERSION \
    REACT_APP_ORDER_API=$REACT_APP_ORDER_API \
    REACT_APP_CART_API=$REACT_APP_CART_API \
    REACT_APP_AUTH_API=$REACT_APP_AUTH_API \
    REACT_APP_PAYMENT_API=$REACT_APP_PAYMENT_API \
    REACT_APP_SEARCH_API=$REACT_APP_SEARCH_API \
    REACT_APP_RECOMMENDATIONS_API=$REACT_APP_RECOMMENDATIONS_API \
    REACT_APP_NOTIFICATIONS_API=$REACT_APP_NOTIFICATIONS_API

COPY package.json package-lock.json* ./
RUN npm install --legacy-peer-deps

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/build /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
