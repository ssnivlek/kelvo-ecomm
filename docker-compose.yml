version: '3.9'

# ================================================================
# Kelvo E-Comm - Docker Compose (Local Development)
# ================================================================
# Databases: PostgreSQL (orders, users) + Redis (carts, payments)
# Datadog Agent uses UDS (Unix Domain Sockets) via /var/run/datadog
# for APM trace collection — same pattern as ECS Fargate production.
#
# Usage:
#   cp .env.local .env
#   docker-compose up -d
# ================================================================

volumes:
  dd-sockets:
  pgdata:
  redisdata:

services:

  # ────────────────────────────────────────────────────────────
  # PostgreSQL (RDS on AWS)
  # ────────────────────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    container_name: rum-shop-postgres
    environment:
      - POSTGRES_DB=rumshop
      - POSTGRES_USER=rumshop
      - POSTGRES_PASSWORD=rumshop
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./infrastructure/postgres-init.sql:/docker-entrypoint-initdb.d/01-datadog.sql:ro
    labels:
      com.datadoghq.ad.check_names: '["postgres"]'
      com.datadoghq.ad.init_configs: '[{}]'
      com.datadoghq.ad.instances: '[{"host":"%%host%%","port":5432,"username":"datadog","password":"datadog","dbname":"rumshop","dbm":true,"collect_activity_metrics":true,"collect_database_size_metrics":true}]'
      com.datadoghq.ad.logs: '[{"source":"postgresql","service":"rum-shop-postgres"}]'
    networks:
      - rumshop
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U rumshop"]
      interval: 5s
      timeout: 5s
      retries: 10

  # ────────────────────────────────────────────────────────────
  # Redis (ElastiCache on AWS)
  # ────────────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: rum-shop-redis
    ports:
      - "6379:6379"
    volumes:
      - redisdata:/data
    command: redis-server --appendonly yes
    labels:
      com.datadoghq.ad.check_names: '["redisdb"]'
      com.datadoghq.ad.init_configs: '[{}]'
      com.datadoghq.ad.instances: '[{"host":"%%host%%","port":6379}]'
      com.datadoghq.ad.logs: '[{"source":"redis","service":"rum-shop-redis"}]'
    networks:
      - rumshop
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10

  # ────────────────────────────────────────────────────────────
  # Datadog Agent (UDS sockets for APM)
  # ────────────────────────────────────────────────────────────
  datadog-agent:
    image: gcr.io/datadoghq/agent:7
    container_name: dd-agent
    environment:
      - DD_API_KEY=${DD_API_KEY:-your_datadog_api_key}
      - DD_SITE=${DD_SITE:-datadoghq.com}
      - DD_ENV=${DD_ENV:-local}
      - DD_APM_ENABLED=true
      - DD_APM_NON_LOCAL_TRAFFIC=true
      - DD_APM_RECEIVER_SOCKET=/var/run/datadog/apm.socket
      - DD_DOGSTATSD_SOCKET=/var/run/datadog/dsd.socket
      - DD_DOGSTATSD_NON_LOCAL_TRAFFIC=true
      - DD_LOGS_ENABLED=true
      - DD_LOGS_CONFIG_AUTO_MULTI_LINE_DETECTION=true
      - DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL=true
      - DD_CONTAINER_EXCLUDE_LOGS=name:dd-agent
      - DD_PROCESS_AGENT_ENABLED=true
    ports:
      - "8126:8126"
      - "8125:8125/udp"
    volumes:
      - dd-sockets:/var/run/datadog
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    networks:
      - rumshop

  # ────────────────────────────────────────────────────────────
  # [EC2] Java Order Service — PostgreSQL + dd-java-agent via UDS
  # ────────────────────────────────────────────────────────────
  order-service:
    build:
      context: ./backend/java-order-service
      dockerfile: Dockerfile
    container_name: rum-shop-order-service
    environment:
      - DD_SERVICE=rum-shop-order-service
      - DD_ENV=${DD_ENV:-local}
      - DD_VERSION=1.0.0
      - DD_TRACE_AGENT_URL=unix:///var/run/datadog/apm.socket
      - DD_PROFILING_ENABLED=true
      - DD_LOGS_INJECTION=true
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/rumshop
      - SPRING_DATASOURCE_USERNAME=rumshop
      - SPRING_DATASOURCE_PASSWORD=rumshop
    ports:
      - "8080:8080"
    volumes:
      - dd-sockets:/var/run/datadog
    depends_on:
      postgres:
        condition: service_healthy
      datadog-agent:
        condition: service_started
    labels:
      com.datadoghq.ad.logs: '[{"source":"java","service":"rum-shop-order-service"}]'
    networks:
      - rumshop
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ────────────────────────────────────────────────────────────
  # [ECS Fargate] Node.js Cart — Redis + dd-trace/init via UDS
  # ────────────────────────────────────────────────────────────
  cart-service:
    build:
      context: ./backend/nodejs-lambdas
      dockerfile: Dockerfile.cart
    container_name: rum-shop-cart
    environment:
      - DD_SERVICE=rum-shop-cart
      - DD_ENV=${DD_ENV:-local}
      - DD_VERSION=1.0.0
      - DD_TRACE_AGENT_URL=unix:///var/run/datadog/apm.socket
      - PORT=3001
      - REDIS_URL=redis://redis:6379
    ports:
      - "3001:3001"
    volumes:
      - dd-sockets:/var/run/datadog
    depends_on:
      redis:
        condition: service_healthy
      datadog-agent:
        condition: service_started
    labels:
      com.datadoghq.ad.logs: '[{"source":"nodejs","service":"rum-shop-cart"}]'
    networks:
      - rumshop

  # ────────────────────────────────────────────────────────────
  # [ECS Fargate] Node.js Auth — PostgreSQL + dd-trace/init via UDS
  # ────────────────────────────────────────────────────────────
  auth-service:
    build:
      context: ./backend/nodejs-lambdas
      dockerfile: Dockerfile.auth
    container_name: rum-shop-auth
    environment:
      - DD_SERVICE=rum-shop-auth
      - DD_ENV=${DD_ENV:-local}
      - DD_VERSION=1.0.0
      - DD_TRACE_AGENT_URL=unix:///var/run/datadog/apm.socket
      - JWT_SECRET=${JWT_SECRET:-rum-shop-local-secret-key-2024}
      - PORT=3002
      - DATABASE_URL=postgresql://rumshop:rumshop@postgres:5432/rumshop
    ports:
      - "3002:3002"
    volumes:
      - dd-sockets:/var/run/datadog
    depends_on:
      postgres:
        condition: service_healthy
      datadog-agent:
        condition: service_started
    labels:
      com.datadoghq.ad.logs: '[{"source":"nodejs","service":"rum-shop-auth"}]'
    networks:
      - rumshop

  # ────────────────────────────────────────────────────────────
  # [ECS Fargate] Node.js Payment — Redis + dd-trace/init via UDS
  # ────────────────────────────────────────────────────────────
  payment-service:
    build:
      context: ./backend/nodejs-lambdas
      dockerfile: Dockerfile.payment
    container_name: rum-shop-payment
    environment:
      - DD_SERVICE=rum-shop-payment
      - DD_ENV=${DD_ENV:-local}
      - DD_VERSION=1.0.0
      - DD_TRACE_AGENT_URL=unix:///var/run/datadog/apm.socket
      - PORT=3003
      - REDIS_URL=redis://redis:6379
    ports:
      - "3003:3003"
    volumes:
      - dd-sockets:/var/run/datadog
    depends_on:
      redis:
        condition: service_healthy
      datadog-agent:
        condition: service_started
    labels:
      com.datadoghq.ad.logs: '[{"source":"nodejs","service":"rum-shop-payment"}]'
    networks:
      - rumshop

  # ────────────────────────────────────────────────────────────
  # [Lambda] Python Search — ddtrace-run via UDS
  # ────────────────────────────────────────────────────────────
  search-service:
    build:
      context: ./backend/python-lambdas
      dockerfile: Dockerfile.search
    container_name: rum-shop-search
    environment:
      - DD_SERVICE=rum-shop-search
      - DD_ENV=${DD_ENV:-local}
      - DD_VERSION=1.0.0
      - DD_TRACE_AGENT_URL=unix:///var/run/datadog/apm.socket
      - PORT=3004
    ports:
      - "3004:3004"
    volumes:
      - dd-sockets:/var/run/datadog
    depends_on:
      - datadog-agent
    labels:
      com.datadoghq.ad.logs: '[{"source":"python","service":"rum-shop-search"}]'
    networks:
      - rumshop

  # ────────────────────────────────────────────────────────────
  # [Lambda] Python Recommendations — ddtrace-run via UDS
  # ────────────────────────────────────────────────────────────
  recommendations-service:
    build:
      context: ./backend/python-lambdas
      dockerfile: Dockerfile.recommendations
    container_name: rum-shop-recommendations
    environment:
      - DD_SERVICE=rum-shop-recommendations
      - DD_ENV=${DD_ENV:-local}
      - DD_VERSION=1.0.0
      - DD_TRACE_AGENT_URL=unix:///var/run/datadog/apm.socket
      - PORT=3005
    ports:
      - "3005:3005"
    volumes:
      - dd-sockets:/var/run/datadog
    depends_on:
      - datadog-agent
    labels:
      com.datadoghq.ad.logs: '[{"source":"python","service":"rum-shop-recommendations"}]'
    networks:
      - rumshop

  # ────────────────────────────────────────────────────────────
  # [Lambda] Python Notifications — ddtrace-run via UDS
  # ────────────────────────────────────────────────────────────
  notifications-service:
    build:
      context: ./backend/python-lambdas
      dockerfile: Dockerfile.notifications
    container_name: rum-shop-notifications
    environment:
      - DD_SERVICE=rum-shop-notifications
      - DD_ENV=${DD_ENV:-local}
      - DD_VERSION=1.0.0
      - DD_TRACE_AGENT_URL=unix:///var/run/datadog/apm.socket
      - PORT=3006
    ports:
      - "3006:3006"
    volumes:
      - dd-sockets:/var/run/datadog
    depends_on:
      - datadog-agent
    labels:
      com.datadoghq.ad.logs: '[{"source":"python","service":"rum-shop-notifications"}]'
    networks:
      - rumshop

  # ────────────────────────────────────────────────────────────
  # Swagger UI — OpenAPI docs at http://localhost:8888
  # ────────────────────────────────────────────────────────────
  swagger-ui:
    image: swaggerapi/swagger-ui:latest
    container_name: rum-shop-swagger
    environment:
      - SWAGGER_JSON=/spec/openapi.yaml
      - BASE_URL=/
    ports:
      - "8888:8080"
    volumes:
      - ./docs:/spec:ro
    networks:
      - rumshop

  # ────────────────────────────────────────────────────────────
  # [S3+CloudFront] React Frontend
  # ────────────────────────────────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: rum-shop-frontend
    environment:
      - REACT_APP_DD_APPLICATION_ID=${REACT_APP_DD_APPLICATION_ID:-rum-shop-app-id}
      - REACT_APP_DD_CLIENT_TOKEN=${REACT_APP_DD_CLIENT_TOKEN:-pub_rum_shop_client_token}
      - REACT_APP_DD_SITE=${DD_SITE:-datadoghq.com}
      - REACT_APP_DD_ENV=${DD_ENV:-local}
      - REACT_APP_ORDER_API=http://localhost:8080
      - REACT_APP_CART_API=http://localhost:3001
      - REACT_APP_AUTH_API=http://localhost:3002
      - REACT_APP_PAYMENT_API=http://localhost:3003
      - REACT_APP_SEARCH_API=http://localhost:3004
      - REACT_APP_RECOMMENDATIONS_API=http://localhost:3005
      - REACT_APP_NOTIFICATIONS_API=http://localhost:3006
    ports:
      - "3000:80"
    depends_on:
      - order-service
      - cart-service
      - auth-service
      - payment-service
      - search-service
      - recommendations-service
      - notifications-service
    networks:
      - rumshop

networks:
  rumshop:
    driver: bridge
